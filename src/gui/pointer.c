#include "../drivers/vesa.h"
#include "../drivers/mouse.h"
#include "../lib/stdint.h"
#include "../lib/stddef.h"

#include "pointer.h"

static mouse_state_t current_state;
static volatile uint32_t last_poll = 0;
static uint8_t under_cursor_bmp[13 * 15 * 4];

static uint32_t screen_width;
static uint32_t screen_height;

static uint8_t cursor_bmp[13 * 15 * 4] =
{
    0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18,
    0x18, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18,
    0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18,
    0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18,
    0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static void mouse_event(void)
{
    mouse_state_t new_state;
    uint32_t bmp_index;
    uint32_t offset;
    uint32_t i;
    uint32_t j;

    get_mouse_state(&new_state);

    /* Manage mouse sensitivity */
    if(current_state.flags == new_state.flags && last_poll++ < 2)
    {
        return;
    }
    last_poll = 0;

    /* Restore what was under the cursor */
    bmp_index = 0;
    offset = 0;
    for(i = current_state.pos_y; i < (uint32_t)current_state.pos_y + 15 && i < screen_height; ++i)
    {
        bmp_index = 0;
        for(j = current_state.pos_x; j < (uint32_t)current_state.pos_x + 13  && j < screen_width; ++j)
        {
            vesa_draw_pixel(j, i,
                            under_cursor_bmp[offset + bmp_index + 3],
                            under_cursor_bmp[offset + bmp_index],
                            under_cursor_bmp[offset + bmp_index + 1],
                            under_cursor_bmp[offset + bmp_index + 2]);
           bmp_index = (bmp_index + 4) % (13 * 4);
        }
        offset += 13 * 4;
    }

    /* Compute new position */
    current_state.pos_x += new_state.pos_x * 2;
    current_state.pos_y -= new_state.pos_y * 2;
    current_state.flags = new_state.flags;

    if(current_state.pos_y < 0)
    {
        current_state.pos_y = 0;
    }
    else if((uint32_t)current_state.pos_y >= screen_height)
    {
        current_state.pos_y = screen_height - 1;
    }
    if(current_state.pos_x < 0)
    {
        current_state.pos_x = 0;
    }
    else if((uint32_t)current_state.pos_x >= screen_width)
    {
        current_state.pos_x = screen_width - 1;
    }

    draw_mouse(current_state.pos_x, current_state.pos_y);
}

void draw_mouse(const uint32_t x, const uint32_t y)
{
    uint32_t i;
    uint32_t j;
    uint32_t bmp_index;
    uint32_t offset;

    bmp_index = 0;
    offset = 0;
    for(i = y; i < y + 15 && i < screen_height; ++i)
    {
        bmp_index = 0;
        for(j = x; j < x + 13  && j < screen_width; ++j)
        {
            /* Get pixel to save it */
            vesa_get_pixel(j, i,
                            &under_cursor_bmp[offset + bmp_index + 3],
                            &under_cursor_bmp[offset + bmp_index],
                            &under_cursor_bmp[offset + bmp_index + 1],
                            &under_cursor_bmp[offset + bmp_index + 2]);

            /* Display new pixel */
            vesa_draw_pixel(j, i,
                            cursor_bmp[offset + bmp_index + 3],
                            (current_state.flags & MOUSE_LEFT_CLICK) ? ~cursor_bmp[offset + bmp_index] : cursor_bmp[offset + bmp_index],
                            (current_state.flags & MOUSE_LEFT_CLICK) ? ~cursor_bmp[offset + bmp_index + 1] : cursor_bmp[offset + bmp_index + 1],
                            (current_state.flags & MOUSE_LEFT_CLICK) ? ~cursor_bmp[offset + bmp_index + 2] : cursor_bmp[offset + bmp_index + 2]);

            bmp_index = (bmp_index + 4) % (13 * 4);
        }
        offset += 13 * 4;
    }
}

OS_RETURN_E init_pointer(void)
{
    OS_RETURN_E err;
    uint32_t i;
    uint32_t j;
    uint32_t bmp_index;
    uint32_t offset;

    err = register_mouse_event(&mouse_event, NULL);
    if(err != OS_NO_ERR)
    {
        return err;
    }

    screen_width = vesa_get_screen_width();
    screen_height = vesa_get_screen_height();

    current_state.pos_x = screen_width / 2 - 13 / 2;
    current_state.pos_y = screen_height / 2 - 15 / 2;
    current_state.flags = 0;

    bmp_index = 0;
    offset = 0;
    for(i = current_state.pos_y; i < (uint32_t)current_state.pos_y + 15 && i < screen_height; ++i)
    {
        bmp_index = 0;
        for(j = current_state.pos_x ; j < (uint32_t)current_state.pos_x + 13  && j < screen_width; ++j)
        {
            /* Get pixel to save it */
            vesa_get_pixel(j, i,
                            &under_cursor_bmp[offset + bmp_index + 3],
                            &under_cursor_bmp[offset + bmp_index],
                            &under_cursor_bmp[offset + bmp_index + 1],
                            &under_cursor_bmp[offset + bmp_index + 2]);
            bmp_index = (bmp_index + 4) % (13 * 4);
        }
        offset += 13 * 4;
    }

    draw_mouse(current_state.pos_x, current_state.pos_y);

    return OS_NO_ERR;
}
