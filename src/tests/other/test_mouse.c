#include "../../drivers/vesa.h"
#include "../../drivers/rtc.h"
#include "../../lib/stdio.h"
#include "../../drivers/mouse.h"
#include "../../core/scheduler.h"
#include "../../sync/semaphore.h"
#include "bg.h"

#define TEST_PALETTE 1
#define TEST_LIGNES  0

mouse_state_t current_state;

int32_t screen_width;
int32_t screen_height;

uint8_t blink = 0;
uint32_t i;
uint8_t last_seconds = 0;
volatile uint32_t last_poll = 0;

uint8_t under_cursor_bmp[13 * 15 * 4];
uint8_t cursor_bmp[13 * 15 * 4] = {
    0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18,
    0x18, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18,
    0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18,
    0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18,
    0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0x18,
    0x18, 0x18, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x18, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

};

void mouse_event(void)
{
    if(last_poll++ < 1)
    {
        return;
    }
    mouse_state_t new_state;
    get_mouse_state(&new_state);

    last_poll = 0;

    int32_t bmp_index = 0;
    int32_t offset = 0;


    for(int32_t i = current_state.pos_y; i < current_state.pos_y + 15 && i < screen_height; ++i)
    {
        bmp_index = 0;
        for(int32_t j = current_state.pos_x; j < current_state.pos_x + 13  && j < screen_width; ++j)
        {
           {
                vesa_draw_pixel(j, i,
                                under_cursor_bmp[offset + bmp_index + 3], under_cursor_bmp[offset + bmp_index], under_cursor_bmp[offset + bmp_index + 1], under_cursor_bmp[offset + bmp_index + 2]);
           }

           bmp_index = (bmp_index + 4) % (13 * 4);
        }
        offset += 13 * 4;
    }

    current_state.pos_x += new_state.pos_x * 2;
    current_state.pos_y -= new_state.pos_y * 2;
    current_state.flags = new_state.flags;

    if(current_state.pos_y < 0)
        current_state.pos_y = 0;
    if(current_state.pos_x < 0)
        current_state.pos_x = 0;
    if(current_state.pos_y >= screen_height)
        current_state.pos_y = screen_height - 1;
    if(current_state.pos_x >= screen_width)
        current_state.pos_x = screen_width - 1;

    bmp_index = 0;
    offset = 0;

    for(int32_t i = current_state.pos_y; i < current_state.pos_y + 15 && i < screen_height; ++i)
    {
        bmp_index = 0;
        for(int32_t j = current_state.pos_x; j < current_state.pos_x + 13  && j < screen_width; ++j)
        {
           {
                vesa_get_pixel(j, i,
                                &under_cursor_bmp[offset + bmp_index + 3], &under_cursor_bmp[offset + bmp_index], &under_cursor_bmp[offset + bmp_index + 1], &under_cursor_bmp[offset + bmp_index + 2]);
           }

           bmp_index = (bmp_index + 4) % (13 * 4);
        }
        offset += 13 * 4;
    }

    bmp_index = 0;
    offset = 0;
    for(int32_t i = current_state.pos_y; i < current_state.pos_y + 15 && i < screen_height; ++i)
    {
        bmp_index = 0;
        for(int32_t j = current_state.pos_x; j < current_state.pos_x + 13  && j < screen_width; ++j)
        {
              if(cursor_bmp[offset + bmp_index + 3] != 0)
           {
                vesa_draw_pixel(j, i,
                                cursor_bmp[offset + bmp_index + 3], cursor_bmp[offset + bmp_index], cursor_bmp[offset + bmp_index + 1], cursor_bmp[offset + bmp_index + 2]);
           }

           bmp_index = (bmp_index + 4) % (13 * 4);
        }
        offset += 13 * 4;
    }
}
#include "../../debug.h"
void start_gui(void)
{
    current_state.pos_x = 160;
    current_state.pos_y = 100;

    screen_width = vesa_get_screen_width();
    screen_height = vesa_get_screen_height();

    kernel_serial_debug("%d | %d\n", screen_width, screen_height);
    register_mouse_event(&mouse_event, NULL);

    uint32_t img_width = gimp_image.width;
    uint32_t img_height = gimp_image.height;
    uint32_t bmp_index = 0;
    for(int32_t i = 0; i < screen_height; ++i)
    {
        uint32_t offset = (gimp_image.bytes_per_pixel * img_width * i) % (img_width * img_height * gimp_image.bytes_per_pixel);
        bmp_index = 0;
        for(int32_t j = 0; j < screen_width; ++j)
        {
            uint32_t offset_line = offset + bmp_index;
            vesa_draw_pixel(j, i, gimp_image.pixel_data[offset_line + 3], gimp_image.pixel_data[offset_line], gimp_image.pixel_data[offset_line + 1], gimp_image.pixel_data[offset_line + 2]);
            bmp_index = (bmp_index + gimp_image.bytes_per_pixel) % (gimp_image.bytes_per_pixel * img_width);
        }
    }
    vesa_draw_rectangle(0, 0,
                    screen_width, 40,
                    0x4A, 0x2c, 0x3e, 0x50);

    int32_t offset = 0;

    for(int32_t i = current_state.pos_y; i < current_state.pos_y + 15 && i < screen_height; ++i)
    {
        bmp_index = 0;
        for(int32_t j = current_state.pos_x; j < current_state.pos_x + 13  && j < screen_width; ++j)
        {
           {
                vesa_get_pixel(j, i,
                                &under_cursor_bmp[offset + bmp_index + 3], &under_cursor_bmp[offset + bmp_index], &under_cursor_bmp[offset + bmp_index + 1], &under_cursor_bmp[offset + bmp_index + 2]);
           }

           bmp_index = (bmp_index + 4) % (13 * 4);
        }
        offset += 13 * 4;
    }

    offset = 0;
    for(int32_t i = current_state.pos_y; i < current_state.pos_y + 15 && i < screen_height; ++i)
    {
        bmp_index = 0;
        for(int32_t j = current_state.pos_x; j < current_state.pos_x + 13  && j < screen_width; ++j)
        {

           {
                vesa_draw_pixel(j, i,
                                under_cursor_bmp[offset + bmp_index + 3], under_cursor_bmp[offset + bmp_index], under_cursor_bmp[offset + bmp_index + 1], under_cursor_bmp[offset + bmp_index + 2]);
           }

           bmp_index = (bmp_index + 4) % (13 * 4);
        }
        offset += 13 * 4;
    }

    /* Save background of clock */
    uint32_t save[64*16];
    uint32_t start_position_x = screen_width / 2 - 4 * 8;
    uint32_t start_position_y = 13;
    offset = 0;

    for(uint32_t i = start_position_y; i < start_position_y + 16; ++i)
    {
        for(uint32_t j = start_position_x; j < start_position_x + 64; ++j)
        {
            uint8_t* addr = (uint8_t*) &save[offset];
            vesa_get_pixel(j, i,
                            addr + 3, addr + 2, addr + 1, addr);
            ++offset;
        }
    }

    while(1)
    {
        uint32_t time = get_current_daytime();
        uint32_t seconds = time % 60;
        uint32_t minutes = (time / 60) % 60;
        uint32_t hours = time / 3600;

        char time_str[8];

        if(seconds != last_seconds)
        {
            blink = (blink + 1) % 2;
        }
        last_seconds = seconds;

        time_str[0] = (hours / 10) + 48;
        time_str[1] = (hours % 10) + 48;
        time_str[3] = (minutes / 10) + 48;
        time_str[4] = (minutes % 10) + 48;
        time_str[6] = (seconds / 10) + 48;
        time_str[7] = (seconds % 10) + 48;

        if(blink)
        {
            time_str[2] = ':';
            time_str[5] = ':';
        }
        else
        {
            time_str[2] = ' ';
            time_str[5] = ' ';
        }

        /* Clean time */
        offset = 0;
        for(uint32_t i = start_position_y; i < start_position_y + 16; ++i)
        {
            for(uint32_t j = start_position_x; j < start_position_x + 64; ++j)
            {
                vesa_draw_pixel(j, i, (uint8_t)(save[offset] >> 24), (uint8_t)(save[offset] >> 16), (uint8_t)(save[offset] >> 8), (uint8_t)save[offset]);
                ++offset;
            }
        }

        for(i = 0; i < 8; ++i)
        {
            vesa_drawchar(time_str[i], start_position_x + i * 8, start_position_y,  0xFFFFFFFF, 0x00000000);
        }


        sleep(500);
    }
}
